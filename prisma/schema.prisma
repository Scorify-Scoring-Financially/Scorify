// ===============================================
// PRISMA SCHEMA - SCORIFY LEAD SCORING SYSTEM
// Dibuat oleh: Naufal
// Versi: Final (Sales Campaign + ML Integration)
// ===============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

// ===============================================
// 1. MODEL UNTUK AUTENTIKASI APLIKASI
// (Sales / Admin yang menggunakan portal)
// ===============================================

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String?
  phone        String?
  passwordHash String
  role         UserRole @default(Sales)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relasi
  passwordResetTokens PasswordResetToken[]
  createdCampaigns    Campaign[]

  // Relasi ke log interaksi (sales/admin yang mencatat)
  interactionLogs     InteractionLog[]
}

enum UserRole {
  Sales
  Admin
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  expiresAt DateTime

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([userId])
}


// ===============================================
// 2. MODEL UNTUK DATA LEAD SCORING 
// (Data nasabah/customer yang akan di-skor)
// ===============================================

// --- 2.1. Tabel Utama: Customer ---
model Customer {
  id      String @id @default(cuid())
  
  // Data Personal (PII)
  name    String
  email   String @unique
  phone   String?
  address String? // Alamat versi 1 baris

  // Data Demografis (untuk Model ML)
  age       Int
  job       Job
  marital   MaritalStatus
  education Education
  default   YesNoUnknown // Apakah memiliki kredit macet?
  balance   Float
  housing   YesNoUnknown // Memiliki kredit rumah?
  loan      YesNoUnknown // Memiliki pinjaman pribadi?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relasi: 1 Customer punya banyak riwayat Kampanye & banyak Skor
  campaigns       Campaign[]
  leadScores      LeadScore[]
  interactionLogs InteractionLog[]

  // Indeks untuk optimasi pencarian
  @@index([name])
  @@index([email])
}


// --- 2.2. Riwayat Kampanye ---
model Campaign {
  id             String   @id @default(cuid())

  // Informasi kontak
  contact        ContactType
  day_of_week    String
  month          String
  campaign       Int          // Jumlah kontak selama kampanye
  previous       Int          // Jumlah kontak sebelumnya
  pdays          Int          // Hari sejak terakhir dihubungi
  poutcome       POutcome     // Hasil kampanye sebelumnya

  // Hasil akhir kampanye (diset oleh sales)
  finalDecision  AgreementStatus?

  createdAt DateTime @default(now())

  // Relasi dengan customer & user
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  userId String?
  user   User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Relasi ke hasil prediksi ML
  leadScores LeadScore[]

  @@index([customerId])
  @@index([userId])
  @@index([month])
}


// --- 2.3. Data Makroekonomi ---
model MacroData {
  id             String   @id @default(cuid())
  month          String   @unique
  emp_var_rate   Float
  cons_price_idx Float
  cons_conf_idx  Float
  euribor3m      Float
  nr_employed    Float

  createdAt DateTime @default(now())
}


// --- 2.4. Hasil Prediksi Model ---
model LeadScore {
  id          String     @id @default(cuid())
  predicted_y Prediction // yes/no apakah nasabah akan membeli produk
  score       Float       // probabilitas / confidence score

  createdAt DateTime @default(now())

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([campaignId])
  @@index([score])
}


// --- 2.5. Riwayat & Catatan Interaksi Nasabah ---
model InteractionLog {
  id          String   @id @default(cuid())

  // Jenis interaksi, contoh: "Panggilan Telepon", "Catatan Internal"
  type        InteractionType

  // Catatan yang ditulis oleh sales/admin
  note        String

  // Waktu interaksi
  createdAt   DateTime @default(now())

  // Relasi: interaksi ini milik Customer
  customerId  String
  customer    Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Relasi: siapa yang mencatat (Sales/Admin)
  userId      String?
  user        User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Opsional: hasil panggilan (jika tipe = PANGGILAN_TELEPON)
  callResult  CallResult?

  @@index([customerId])
  @@index([userId])
}


// ===============================================
// 3. ENUMS / KATEGORI TETAP
// ===============================================

enum Job {
  admin
  technician
  services
  management
  retired
  blue_collar
  unemployed
  entrepreneur
  housemaid
  self_employed
  student
  unknown
}

enum MaritalStatus {
  married
  single
  divorced
}

enum Education {
  basic_4y
  basic_6y
  basic_9y
  high_school
  university_degree
  professional_course
  unknown
}

enum YesNoUnknown {
  yes
  no
  unknown
}

enum AgreementStatus {
  agreed        // Nasabah setuju
  declined      // Nasabah menolak
  pending       // Masih menunggu keputusan
}

enum ContactType {
  cellular
  telephone
}

enum POutcome {
  nonexistent
  failure
  success
}

enum Prediction {
  yes
  no
}

enum InteractionType {
  PANGGILAN_TELEPON
  CATATAN_INTERNAL
}

enum CallResult {
  success
  failure
  no_answer
  unknown
}
