generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
//  MODEL USER DAN AUTENTIKASI
// ============================================

model User {
  id                  String               @id @default(cuid()) @db.VarChar(255)
  email               String               @unique @db.VarChar(255)
  name                String?              @db.VarChar(255)
  phone               String?              @db.VarChar(255)
  passwordHash        String               @db.VarChar(255)
  role                String               @default("Sales") @db.VarChar(50)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt

  // Relasi
  createdCampaigns    Campaign[]
  interactionLogs     InteractionLog[]
  passwordResetTokens PasswordResetToken[]
}

model PasswordResetToken {
  id        String   @id @default(cuid()) @db.VarChar(255)
  token     String   @unique @db.VarChar(255)
  expiresAt DateTime
  userId    String   @db.VarChar(255)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ============================================
//  MODEL CUSTOMER
// ============================================

model Customer {
  id              String           @id @db.VarChar(255)
  name            String           @db.VarChar(255)
  email           String           @unique @db.VarChar(255)
  phone           String?          @db.VarChar(255)
  address         String?
  age             Int
  job             String           @default("unknown") @db.VarChar(50)
  marital         String           @default("unknown") @db.VarChar(50)
  education       String           @default("unknown") @db.VarChar(50)
  default         String           @default("unknown") @db.VarChar(20)
  balance         Float            @db.Real
  housing         String           @default("unknown") @db.VarChar(20)
  loan            String           @default("unknown") @db.VarChar(20)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  // Relasi
  campaigns       Campaign[]
  interactionLogs InteractionLog[]
  leadScores      LeadScore[]
  leadscore       leadscore[]

  @@index([name])
  @@index([email])
}

// ============================================
//  MODEL CAMPAIGN (dengan relasi finalDecision)
// ============================================

model Campaign {
  id             String      @id @db.VarChar(255)
  contact        String      @default("unknown") @db.VarChar(50)
  day_of_week    String      @default("unknown") @db.VarChar(50)
  month          String      @default("unknown") @db.VarChar(50)
  campaign       Int
  previous       Int
  pdays          Int
  poutcome       String      @default("unknown") @db.VarChar(50)
  createdAt      DateTime    @default(now())

  // Relasi utama
  customerId     String      @db.VarChar(255)
  userId         String?     @db.VarChar(255)
  customer       Customer    @relation(fields: [customerId], references: [id], onDelete: Cascade)
  user           User?       @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Tambahan dari schema baru (finalDecision)
  finalDecision  FinalDecision?

  // Relasi ke skor dan prediksi
  leadScores     LeadScore[]
  leadscore      leadscore[]

  @@index([customerId])
  @@index([userId])
  @@index([month])
}

// ============================================
//  MODEL MACRODATA
// ============================================

model MacroData {
  id             String   @id @db.VarChar(255)
  month          String   @unique @db.VarChar(50)
  emp_var_rate   Float    @db.Real
  cons_price_idx Float    @db.Real
  cons_conf_idx  Float    @db.Real
  euribor3m      Float    @db.Real
  nr_employed    Float    @db.Real
  createdAt      DateTime @default(now())
}

// ============================================
//  MODEL LEADSCORE (modern)
// ============================================

model LeadScore {
  id            String    @id @default(cuid()) @db.VarChar
  customerId    String    @db.VarChar
  campaignId    String    @db.VarChar
  predicted_y   String?   @db.VarChar
  score         Float?
  threshold     Float?
  model_version String?   @db.VarChar
  batch_id      String?   @db.VarChar
  createdAt     DateTime? @db.Timestamp(6)

  campaign      Campaign  @relation(fields: [campaignId], references: [id], onDelete: NoAction)
  customer      Customer  @relation(fields: [customerId], references: [id], onDelete: NoAction)

  @@index([batch_id], map: "ix_LeadScore_batch_id")
  @@index([id], map: "ix_LeadScore_id")
}

// ============================================
//  MODEL INTERACTION LOG (pakai enum modern)
// ============================================

model InteractionLog {
  id          String          @id @default(cuid()) @db.VarChar(255)
  type        InteractionType @default(CATATAN_INTERNAL)
  note        String
  createdAt   DateTime        @default(now())
  customerId  String          @db.VarChar(255)
  userId      String?         @db.VarChar(255)
  callResult  CallResult?     @default(unknown)

  customer    Customer        @relation(fields: [customerId], references: [id], onDelete: Cascade)
  user        User?           @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([customerId])
  @@index([userId])
}

// ============================================
//  MODEL LEADSCORE (lama, tetap dipertahankan)
// ============================================

model leadscore {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  customerid  String    @db.VarChar
  campaignid  String    @db.VarChar
  predicted_y String    @db.VarChar
  score       Float?
  createdat   DateTime? @default(now()) @db.Timestamp(6)
  Campaign    Campaign  @relation(fields: [campaignid], references: [id], onDelete: NoAction, map: "fk_campaign")
  Customer    Customer  @relation(fields: [customerid], references: [id], onDelete: NoAction, map: "fk_customer")
}

// ============================================
//  ENUMS MODERN (khusus Interaction dan Campaign)
// ============================================

enum FinalDecision {
  agreed
  declined
  pending
}

enum InteractionType {
  PANGGILAN_TELEPON
  CATATAN_INTERNAL
}

enum CallResult {
  success
  failure
  no_answer
  unknown
}
